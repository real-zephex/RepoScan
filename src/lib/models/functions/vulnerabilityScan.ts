"use server";

import { ChatCompletion } from "groq-sdk/resources/chat/completions.mjs";
import GroqClient from "../groqInstance";
// import { ChatCompletionCreateParamsBase } from "groq-sdk/resources/chat/completions.mjs";

export type Severity = "high" | "medium" | "low" | "critical";

export interface Issues {
  line: number;
  severity: Severity; // Severity level
  suggestion: string;
  cwe_id?: string;
  cwe_name?: string;
  category?: string;
  codeSnippet?: string;
  title: string;
}

interface GroqVulnerabilityScanResponseProps {
  status: boolean;
  issues: Issues[];
  error?: string;
}

const groqConfig = {
  model: "openai/gpt-oss-120b",
  temperature: 1,
};

const GroqVulnerabilityScan = async ({
  code,
  filePath,
}: {
  code: string;
  filePath: string;
}): Promise<GroqVulnerabilityScanResponseProps> => {
  try {
    const completitions: ChatCompletion =
      await GroqClient.chat.completions.create({
        ...groqConfig,
        stream: false,
        messages: [
          {
            role: "system",
            content: `
            You are an AI-powered secure code reviewer specializing in CWE/SANS Top 25 vulnerabilities.

            Task:
            - Analyze the following source code for **CWE/SANS Top 25 Most Dangerous Software Weaknesses**.
            - Focus on identifying these critical vulnerability categories:
              
              **Input Validation & Injection (CWE-20, CWE-89, CWE-79, CWE-78, CWE-352)**
              - SQL Injection (CWE-89)
              - Cross-Site Scripting (CWE-79)
              - Command Injection (CWE-78)
              - CSRF (CWE-352)
              
              **Authentication & Session Management (CWE-306, CWE-287, CWE-798, CWE-259)**
              - Missing Authentication (CWE-306)
              - Improper Authentication (CWE-287)
              - Hard-coded Credentials (CWE-798)
              - Weak Password Requirements (CWE-521)
              
              **Access Control (CWE-862, CWE-863, CWE-284)**
              - Missing Authorization (CWE-862)
              - Incorrect Authorization (CWE-863)
              - Path Traversal (CWE-22)
              
              **Cryptographic Issues (CWE-311, CWE-327, CWE-330)**
              - Cleartext Transmission of Sensitive Data (CWE-319)
              - Use of Broken Crypto (CWE-327)
              - Insufficient Randomness (CWE-330)
              
              **Memory Safety (CWE-125, CWE-787, CWE-416, CWE-119)**
              - Buffer Overflow (CWE-119)
              - Out-of-bounds Read/Write (CWE-125, CWE-787)
              - Use After Free (CWE-416)
              
              **Resource Management (CWE-400, CWE-502, CWE-434)**
              - Uncontrolled Resource Consumption (CWE-400)
              - Deserialization of Untrusted Data (CWE-502)
              - Unrestricted File Upload (CWE-434)
              
              **Logic & Business Logic (CWE-20, CWE-918, CWE-601)**
              - Server-Side Request Forgery (CWE-918)
              - Open Redirect (CWE-601)
              - Improper Input Validation (CWE-20)

            Requirements:
            1. Identify vulnerabilities matching CWE/SANS Top 25 categories.
            2. For each issue, provide:
              - line: line number where the issue occurs
              - severity: high / medium / low (based on CWE severity)
              - suggestion: clear actionable fix with secure coding examples
              - cwe_id: CWE identifier (e.g., "CWE-89")
              - cwe_name: human-readable name (e.g., "SQL Injection")
              - category: vulnerability category (e.g., "Injection")
            3. Output **ONLY** valid JSON, with an array of issues.
            4. Prioritize high-severity CWE vulnerabilities.
          `,
          },
          { role: "user", content: code },
        ],
        response_format: {
          type: "json_schema",
          json_schema: {
            name: "VulnerabilityScan",
            schema: {
              type: "object",
              properties: {
                issues: {
                  type: "array",
                  items: {
                    type: "object",
                    properties: {
                      line: {
                        type: "integer",
                        description: "Line number where the issue occurs",
                      },
                      codeSnippet: {
                        type: "string",
                        description: "Code snippet illustrating the issue",
                      },
                      severity: {
                        type: "string",
                        description: "Severity level of the issue",
                        enum: ["critical", "high", "medium", "low"],
                      },
                      suggestion: {
                        type: "string",
                        description:
                          "Clear actionable fix with secure coding examples",
                      },
                      cwe_id: {
                        type: "string",
                        description: "CWE identifier (e.g., CWE-89)",
                      },
                      cwe_name: {
                        type: "string",
                        description: "Human-readable CWE name",
                      },
                      category: {
                        type: "string",
                        description: "Vulnerability category",
                      },
                      title: {
                        type: "string",
                        description: "Brief title of the vulnerability",
                      },
                    },
                    required: [
                      "line",
                      "severity",
                      "suggestion",
                      "cwe_id",
                      "cwe_name",
                      "category",
                    ],
                  },
                },
              },
              required: ["issues"],
            },
          },
        },
      });

    const responseMessage = completitions.choices[0].message;
    if (responseMessage && responseMessage.content) {
      const parsedResponse = JSON.parse(responseMessage.content.trim());
      console.log(parsedResponse);
      return {
        status: true,
        issues: parsedResponse.issues as Issues[],
      };
    }

    return {
      status: false,
      issues: [],
    };
  } catch (error) {
    console.error("Error during vulnerability scan:", error);
    return {
      status: false,
      issues: [],
      error: (error as Error).message || "Unknown error occurred",
    };
  }
};

export default GroqVulnerabilityScan;
